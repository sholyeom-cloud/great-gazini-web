<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Great Gazini 🔮</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <h1>🔮 The Great Gazini</h1>
    <p class="subtitle">AI Tarot Reader & Mystic Psychic</p>
  </header>

  <main>
    <form id="readingForm">
      <label for="name">Tvoje ime:</label>
      <input type="text" id="name" name="name" placeholder="Vpiši ime..." />

      <label for="sign">Znamenje:</label>
      <select id="sign" name="sign">
        <option value="oven">Oven</option><option value="bik">Bik</option>
        <option value="dvojček">Dvojček</option><option value="rak">Rak</option>
        <option value="lev">Lev</option><option value="devica">Devica</option>
        <option value="tehtnica">Tehtnica</option><option value="škorpijon">Škorpijon</option>
        <option value="strelec">Strelec</option><option value="kozorog">Kozorog</option>
        <option value="vodnar">Vodnar</option><option value="ribi">Ribi</option>
      </select>

      <button type="submit">🔮 Preberi svojo usodo</button>
      <button type="button" id="manualBtn">🖐 Vnesi karte ročno</button>
    </form>

    <div id="manualInput" style="display:none;">
      <p>Vnesi 3 karte (ločene z vejico ali presledkom):</p>
      <input type="text" id="manualCards" placeholder="npr. The Sun, Justice, The Fool" />
      <button id="manualSubmit">Pošlji karte</button>
    </div>

    <div id="loading" class="hidden">
      <p>The Great Gazini bere tvojo usodo... ✨</p>
      <audio id="chime" src="{{ url_for('static', filename='chime.mp3') }}" preload="auto"></audio>
    </div>

    <div id="result" class="hidden">
      <div id="cards"></div>
      <p id="reading"></p>
    </div>
  </main>

  <footer>
    <p>Hočeš tvojo spletno stran? <a href="https://instagram.com/sholyeom" target="_blank">@sholyeom</a></p>
  </footer>

  <script>
    const form = document.getElementById("readingForm");
    const loading = document.getElementById("loading");
    const result = document.getElementById("result");
    const cardsDiv = document.getElementById("cards");
    const readingText = document.getElementById("reading");
    const chime = document.getElementById("chime");
    const manualBtn = document.getElementById("manualBtn");
    const manualInput = document.getElementById("manualInput");
    const manualSubmit = document.getElementById("manualSubmit");

    manualBtn.onclick = () => {
      manualInput.style.display =
        manualInput.style.display === "none" ? "block" : "none";
    };

    form.onsubmit = async (e) => {
      e.preventDefault();
      chime.play();
      loading.classList.remove("hidden");
      result.classList.add("hidden");

      const payload = {
        name: document.getElementById("name").value,
        sign: document.getElementById("sign").value
      };

      const r = await fetch("/reading", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      chime.pause(); chime.currentTime = 0;
      loading.classList.add("hidden");
      result.classList.remove("hidden");

      if (data.error) {
        readingText.textContent = "Napaka: " + data.error;
        return;
      }
      cardsDiv.innerHTML = data.cards
        .map(c => `<img src="/cards/${c.toLowerCase().replaceAll(' ', '_')}.png" alt="${c}" />`)
        .join("");
      readingText.textContent = data.reading;
    };

    manualSubmit.onclick = async () => {
      chime.play();
      loading.classList.remove("hidden");
      result.classList.add("hidden");

      const name = document.getElementById("name").value;
      const sign = document.getElementById("sign").value;
      const manualCards = document
        .getElementById("manualCards")
        .value.split(/,|\s+/)
        .filter(c => c.trim().length > 0);

      const r = await fetch("/reading", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, sign, manual: true, cards: manualCards })
      });
      const data = await r.json();
      chime.pause(); chime.currentTime = 0;
      loading.classList.add("hidden");
      result.classList.remove("hidden");

      if (data.error) {
        readingText.textContent = "Napaka: " + data.error;
        return;
      }
      cardsDiv.innerHTML = data.cards
        .map(c => `<img src="/cards/${c.toLowerCase().replaceAll(' ', '_')}.png" alt="${c}" />`)
        .join("");
      readingText.textContent = data.reading;
    };
  </script>
</body>
</html>
